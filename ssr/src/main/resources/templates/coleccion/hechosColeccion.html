<html th:replace="~{layout/baseTemplate :: html( ~{::js-extra} )}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="contenido">
  <div class="container-fluid px-4 py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-1">
            <li class="breadcrumb-item"><a th:href="@{/colecciones}" class="text-decoration-none">Colecciones</a></li>
            <li class="breadcrumb-item active" aria-current="page">Mapa de Hechos</li>
          </ol>
        </nav>
        <h2 class="fw-bold mb-0">
          <i class="uil uil-map-marker text-primary me-2"></i>
          <span th:text="${titulo}">Mapa de hechos</span>
        </h2>
      </div>
      <span class="badge bg-dark rounded-pill px-3 py-2">Explorando Colección</span>
    </div>

    <div class="row g-4">

      <div class="col-lg-3">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
            <h5 class="fw-bold d-flex align-items-center gap-2">
              <i class="uil uil-filter"></i> Filtros
            </h5>
          </div>
          <div class="card-body">
            <form th:action="@{/colecciones/{idColeccion}/hechos (idColeccion=${idColeccion}) }"
              th:object="${filtros}" method="get" id="formFiltros">

              <div class="mb-4 p-3 bg-light rounded border border-dashed">
                <label class="form-label fw-bold small text-uppercase text-muted">Modo de Navegación</label>
                <select th:field="*{curados}" class="form-select border-primary" onchange="this.form.submit()">
                  <option value="No">Irrestricta (Todos)</option>
                  <option value="Si">Curada (Solo Consensuados)</option>
                </select>
                <div class="form-text small mt-2">
                  <i class="uil uil-info-circle"></i> La navegación curada aplica algoritmos de consenso.
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold">Ubicación</label>
                <div class="vstack gap-2">

                  <select th:field="*{provincia}" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">Todas las Provincias</option>
                    <option th:each="p : ${listaProvincias}" th:value="${p}" th:text="${p}"></option>
                  </select>

                  <div>
                    <input th:field="*{municipio}"
                      type="text"
                      list="listaMunicipiosData"
                      class="form-control form-control-sm"
                      placeholder="Municipio..."
                      onchange="this.form.submit()"> <datalist id="listaMunicipiosData">
                      <option th:each="m : ${listaMunicipios}" th:value="${m}"></option>
                    </datalist>
                  </div>

                  <div>
                    <input th:field="*{departamento}"
                      type="text"
                      list="listaDepartamentosData"
                      class="form-control form-control-sm"
                      placeholder="Departamento..."
                      onchange="this.form.submit()">

                    <datalist id="listaDepartamentosData">
                      <option th:each="d : ${listaDepartamentos}" th:value="${d}"></option>
                    </datalist>
                  </div>

                </div>
              </div>

              <hr class="border-secondary opacity-10">

              <div class="mb-3">
                <label for="categoria" class="form-label fw-bold">Categoría</label>
                <input th:field="*{categoria}" id="categoria" type="text" class="form-control" placeholder="Ej: Incendio, Accidente...">
              </div>

              <div class="mb-4">
                <label class="form-label fw-bold">Fecha Acontecimiento</label>
                <div class="input-group input-group-sm mb-2">
                  <span class="input-group-text">Desde</span>
                  <input th:field="*{fecha_acontecimiento_desde}" type="date" class="form-control">
                </div>
                <div class="input-group input-group-sm">
                  <span class="input-group-text">Hasta</span>
                  <input th:field="*{fecha_acontecimiento_hasta}" type="date" class="form-control">
                </div>
              </div>

              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary fw-bold">
                  Aplicar Filtros
                </button>
                <a th:href="@{/colecciones/{id}/hechos(id=${idColeccion})}"
                  class="btn btn-outline-secondary btn-sm">
                  <i class="uil uil-redo"></i> Limpiar
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-9">

        <div th:if="${hechos.empty}" class="alert alert-warning d-flex align-items-center gap-3 shadow-sm" role="alert">
          <i class="uil uil-exclamation-triangle fs-2"></i>
          <div>
            <h5 class="alert-heading mb-1">No se encontraron hechos</h5>
            <p class="mb-0">Intenta ajustar los filtros de búsqueda o cambiar el modo de navegación.</p>
          </div>
        </div>

        <div th:unless="${hechos.empty}" class="card border-0 shadow-sm h-100">
          <div class="card-body p-0 position-relative">
            <div id="map" style="height: 100%; width: 100%; border-radius: 0.5rem;"></div>

            <div class="position-absolute top-0 end-0 m-3 p-2 bg-white rounded shadow-sm opacity-75" style="z-index: 1000; font-size: 0.8rem;">
              <span class="d-block fw-bold"><i class="uil uil-mouse-alt"></i> Interacción:</span>
              Clic en marcador para ver detalle.
            </div>
          </div>

          <div class="card-footer bg-white border-top py-3">
            <nav aria-label="Navegación de hechos">
              <ul class="pagination justify-content-center mb-0">

                <li class="page-item" th:classappend="${paginaActual == 1} ? 'disabled'">
                  <a class="page-link" th:href="@{/colecciones/{idColeccion}/hechos(
                                       idColeccion=${idColeccion}, page=${paginaActual-1},
                                       categoria=${filtros.categoria}, provincia=${filtros.provincia}, 
                                       municipio=${filtros.municipio}, departamento=${filtros.departamento}, 
                                       curados=${filtros.curados}, 
                                       fecha_acontecimiento_desde=${filtros.fecha_acontecimiento_desde},
                                       fecha_acontecimiento_hasta=${filtros.fecha_acontecimiento_hasta})}">
                    <i class="uil uil-angle-left"></i> Anterior
                  </a>
                </li>

                <li class="page-item disabled d-none d-md-block">
                  <span class="page-link">
                    Página <span th:text="${paginaActual}">1</span> de <span th:text="${paginasTotales}">10</span>
                  </span>
                </li>

                <li class="page-item" th:classappend="${paginaActual == paginasTotales} ? 'disabled'">
                  <a class="page-link" th:href="@{/colecciones/{idColeccion}/hechos(
                                       idColeccion=${idColeccion}, page=${paginaActual+1},
                                       categoria=${filtros.categoria}, provincia=${filtros.provincia}, 
                                       municipio=${filtros.municipio}, departamento=${filtros.departamento}, 
                                       curados=${filtros.curados}, 
                                       fecha_acontecimiento_desde=${filtros.fecha_acontecimiento_desde},
                                       fecha_acontecimiento_hasta=${filtros.fecha_acontecimiento_hasta})}">
                    Siguiente <i class="uil uil-angle-right"></i>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<th:block th:fragment="js-extra">
  <script th:inline="javascript">
    /*<![CDATA[*/
    const hechos = /*[[${hechos}]]*/ [];
    const idColeccion = /*[[${idColeccion}]]*/ 0;

    const map = L.map('map').setView([-34.6037, -58.3816], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = [];

    if (hechos && hechos.length > 0) {
      hechos.forEach(function(hecho) {
        if (hecho.latitud && hecho.longitud) {
          const marker = L.marker([hecho.latitud, hecho.longitud]).addTo(map);
          let imagenHTML = '';
          if (hecho.multimedia && hecho.multimedia.length > 0) {
            let img = hecho.multimedia.find(m => m.formato && m.formato.toUpperCase().startsWith('IMAGEN'));
            if (img) {
              imagenHTML = `
                <div style="height: 120px; width: 100%; overflow: hidden; background-color: #f8f9fa;">
                  <img src="${img.ruta}" style="width: 100%; height: 100%; object-fit: cover;" alt="Foto">
                </div>
              `;
            }
          }

          let descCorta = hecho.descripcion ? hecho.descripcion : '';
          if (descCorta.length > 70) {
            descCorta = descCorta.substring(0, 70) + '...';
          }

          const fechaStr = hecho.fechaAcontecimiento ? String(hecho.fechaAcontecimiento).substring(0, 10) : '';

          const popupContent = `
            <div class="card border-0 p-0" style="width: 250px; font-family: sans-serif;">
              ${imagenHTML}
              <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 text-wrap text-start" style="font-size: 0.65rem; line-height: 1.2;">
                    ${hecho.categoria}
                  </span>

                  <small class="text-muted text-nowrap ms-2" style="font-size: 0.65rem; margin-top: 2px;">
                    <i class="uil uil-calendar-alt"></i> ${fechaStr}
                  </small>
                </div>

                <h6 class="fw-bold mb-1 text-dark" style="font-size: 0.9rem; line-height: 1.2;">
                  ${hecho.titulo}
                </h6>

                <p class="text-secondary mb-3" style="font-size: 0.75rem; line-height: 1.3;">
                  ${descCorta}
                </p>

                <a href="/colecciones/${idColeccion}/hechos/${hecho.id}" 
                  class="btn btn-outline-dark btn-sm w-100 py-1 fw-bold" 
                  style="font-size: 0.75rem;">
                  Ver Detalles
                </a>
              </div>
            </div>
`;

          marker.bindPopup(popupContent);
          markers.push(marker);
        }
      });

      if (markers.length > 0) {
        var group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
    /*]]>*/
  </script>
</th:block>

</html>