<html th:replace="~{layout/baseTemplate :: html( ~{::js-extra} )}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="contenido">

    <div class="container py-5">

        <div th:if="${success}" class="alert alert-success alert-dismissible fade show shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="uil uil-check-circle fs-4 me-2"></i>
                <div>
                    <strong class="d-block">¡Éxito!</strong>
                    <span th:text="${success}">Operación realizada correctamente.</span>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="uil uil-exclamation-triangle fs-4 me-2"></i>
                <div>
                    <strong class="d-block">Error</strong>
                    <span th:text="${error}">Ha ocurrido un error al procesar la solicitud.</span>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="mb-4 border-bottom pb-3">
            <h2 class="fw-bold mb-1" th:text="${esEdicion ? 'Editar Colección' : 'Nueva Colección'}">Título</h2>
            <p class="text-muted mb-0">
                <span th:if="${esEdicion}">Modifica los parámetros y criterios existentes.</span>
                <span th:unless="${esEdicion}">Define los parámetros para el nuevo conjunto de datos.</span>
            </p>
        </div>

        <form id="formColeccion" class="needs-validation" th:action="@{${accion}}" th:object="${coleccionForm}"
            method="post" enctype="multipart/form-data">

            <datalist id="list-provincias">
                <option th:each="item : ${listaProvincias}" th:value="${item}"></option>
            </datalist>
            <datalist id="list-municipios">
                <option th:each="item : ${listaMunicipios}" th:value="${item}"></option>
            </datalist>
            <datalist id="list-departamentos">
                <option th:each="item : ${listaDepartamentos}" th:value="${item}"></option>
            </datalist>
            <div class="row g-4">

                <div class="col-lg-7">

                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white py-3 border-bottom-0">
                            <h5 class="fw-bold mb-0 text-primary"><i class="uil uil-info-circle"></i> Detalles Generales
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="titulo" placeholder="Título"
                                    th:field="*{titulo}" required>
                                <label for="titulo">Título de la Colección</label>
                            </div>
                            <div class="form-floating">
                                <textarea class="form-control" placeholder="Descripción" id="descripcion"
                                    style="height: 120px" th:field="*{descripcion}" required></textarea>
                                <label for="descripcion">Descripción</label>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-4">
                        <div
                            class="card-header bg-white py-3 border-bottom-0 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0 text-secondary"><i class="uil uil-filter"></i> Criterios de
                                Pertenencia</h5>
                        </div>
                        <div class="card-body bg-light">

                            <div id="criterios-container" class="vstack gap-2 mb-3">
                                <div class="criterio-item card border-0 shadow-sm"
                                    th:each="criterio, stat : *{criterios}">
                                    <div class="card-body p-2 d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center gap-2 w-100">

                                            <strong class="text-primary small text-uppercase flex-shrink-0"
                                                th:text="${#strings.replace(criterio.tipoFiltro, 'FILTRO_', '')}">TIPO</strong>

                                            <input type="hidden" th:field="*{criterios[__${stat.index}__].tipoFiltro}">

                                            <div class="flex-grow-1">
                                                <div th:if="${criterio.tipoFiltro == 'FILTRO_FUENTE'}">
                                                    <select class="form-select form-select-sm py-1"
                                                        th:field="*{criterios[__${stat.index}__].tipoFuente}">
                                                        <option value="ESTATICA">Fuente Estática (CSV)</option>
                                                        <option value="DINAMICA">Fuente Dinámica (Interna)</option>
                                                        <option value="PROXY_API">Proxy API Cátedra</option>
                                                        <option value="PROXY_METAMAPA">Proxy Otra Instancia MetaMapa
                                                        </option>
                                                    </select>
                                                </div>

                                                <div th:if="${#strings.contains(criterio.tipoFiltro, 'FECHA')}">
                                                    <div class="input-group input-group-sm">
                                                        <input type="date" class="form-control py-1"
                                                            th:field="*{criterios[__${stat.index}__].fechaInicio}">
                                                        <span class="input-group-text py-1">-</span>
                                                        <input type="date" class="form-control py-1"
                                                            th:field="*{criterios[__${stat.index}__].fechaFin}">
                                                    </div>
                                                </div>

                                                <div
                                                    th:unless="${criterio.tipoFiltro == 'FILTRO_FUENTE' or #strings.contains(criterio.tipoFiltro, 'FECHA')}">
                                                    <input type="text" class="form-control form-control-sm py-1"
                                                        th:field="*{criterios[__${stat.index}__].valor}"
                                                        th:attr="list=${criterio.tipoFiltro == 'FILTRO_PROVINCIA' ? 'list-provincias' : 
                                                                       (criterio.tipoFiltro == 'FILTRO_MUNICIPIO' ? 'list-municipios' : 
                                                                       (criterio.tipoFiltro == 'FILTRO_DEPARTAMENTO' ? 'list-departamentos' : null))}">
                                                </div>
                                            </div>
                                        </div>

                                        <button type="button" class="btn btn-link text-danger p-0 ms-2"
                                            onclick="eliminarItem(this, '.criterio-item')">
                                            <i class="uil uil-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="input-group">
                                <select id="tipoCriterioSelect" class="form-select form-select-sm bg-white">
                                    <option value="">Seleccionar criterio...</option>
                                    <option value="FILTRO_CATEGORIA">Categoría</option>
                                    <option value="FILTRO_FECHA_ACONTECIMIENTO">Fecha Acontecimiento</option>
                                    <option value="FILTRO_FECHA_REPORTE">Fecha Reporte</option>
                                    <option value="FILTRO_PROVINCIA">Provincia</option>
                                    <option value="FILTRO_MUNICIPIO">Municipio</option>
                                    <option value="FILTRO_DEPARTAMENTO">Departamento</option>
                                    <option value="FILTRO_FUENTE">Tipo de Fuente</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-dark px-3" onclick="agregarCriterio()">
                                    <i class="uil uil-plus"></i> Agregar
                                </button>
                            </div>

                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3 border-bottom-0">
                            <h5 class="fw-bold mb-0 text-success"><i class="uil uil-shield-check"></i> Reglas de
                                Consenso</h5>
                        </div>
                        <div class="card-body bg-light">
                            <select th:field="*{algoritmoConsenso}" class="form-select form-select-sm bg-white mb-2">
                                <option value="" class="text-muted">Sin algoritmo (Irrestricto)</option>
                                <option value="ABSOLUTO">Consenso Absoluto (100% coincidencia)</option>
                                <option value="MAYORIA_SIMPLE">Mayoría Simple (>50% coincidencia)</option>
                                <option value="MULTIPLES_MENCIONES">Múltiples Menciones (Al menos 2 fuentes)</option>
                            </select>

                            <div class="d-flex align-items-center text-muted small">
                                <i class="uil uil-info-circle me-1"></i>
                                <span>Define cuándo un hecho se considera validado para la navegación curada.</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5">
                    <div class="card border-0 shadow-sm h-100">
                        <div
                            class="card-header bg-white py-3 border-bottom-0 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0 text-warning"><i class="uil uil-server-network"></i> Fuentes de
                                Datos</h5>
                            <button type="button" class="btn btn-sm btn-outline-warning text-dark fw-bold"
                                onclick="agregarFuente()">
                                <i class="uil uil-plus"></i> Agregar
                            </button>
                        </div>

                        <div class="card-body bg-light">
                            <div id="fuentes-container" class="vstack gap-3">
                                <div class="fuente-item card border-0 shadow-sm"
                                    th:each="fuente, iterStat : *{fuentes}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge bg-dark rounded-pill count-badge">Fuente #<span
                                                    th:text="${iterStat.count}">1</span></span>
                                            <button type="button" class="btn btn-link text-danger p-0 btn-sm"
                                                onclick="eliminarItem(this, '.fuente-item')">
                                                <i class="uil uil-trash-alt"></i>
                                            </button>
                                        </div>

                                        <div class="row g-2">
                                            <div class="col-12">
                                                <select class="form-select form-select-sm"
                                                    th:name="|fuentes[${iterStat.index}].tipoFuente|"
                                                    th:value="${fuente.tipoFuente}" onchange="cambiarInputFuente(this)">
                                                    <option value="ESTATICA"
                                                        th:selected="${fuente.tipoFuente == 'ESTATICA'}">Fuente Estática
                                                        (CSV)
                                                    </option>
                                                    <option value="DINAMICA"
                                                        th:selected="${fuente.tipoFuente == 'DINAMICA'}">Fuente Dinámica
                                                        (Interna)
                                                    </option>
                                                    <option value="PROXY_API"
                                                        th:selected="${fuente.tipoFuente == 'PROXY_API'}">Proxy API
                                                        Cátedra
                                                    </option>
                                                    <option value="PROXY_METAMAPA"
                                                        th:selected="${fuente.tipoFuente == 'PROXY_METAMAPA'}">Proxy
                                                        Otra Instancia MetaMapa
                                                </select>
                                            </div>

                                            <div class="col-12 input-container">
                                                <input th:if="${fuente.tipoFuente != 'ESTATICA'}"
                                                    th:type="${fuente.tipoFuente == 'DINAMICA' || fuente.tipoFuente == 'PROXY_API' ? 'hidden' : 'text'}"
                                                    class="form-control form-control-sm fuente-input"
                                                    th:name="|fuentes[${iterStat.index}].url|" th:value="${fuente.url}"
                                                    placeholder="https://..." required>

                                                <div th:if="${fuente.tipoFuente == 'ESTATICA'}"
                                                    class="input-group input-group-sm">
                                                    <span
                                                        class="input-group-text bg-secondary bg-opacity-10 text-dark fw-bold border-end-0">
                                                        <i class="uil uil-file-alt me-1"></i> CSV
                                                    </span>
                                                    <input type="text"
                                                        class="form-control fuente-input border-start-0 bg-light text-muted"
                                                        th:name="|fuentes[${iterStat.index}].url|"
                                                        th:value="${fuente.url}" readonly
                                                        title="Archivo cargado previamente">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${#lists.isEmpty(coleccionForm.fuentes)}" id="empty-state-fuentes"
                                class="text-center py-4 text-muted">
                                <p class="small mt-2">No hay fuentes configuradas.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                <a th:href="@{/colecciones}" class="btn btn-light border px-4">Cancelar</a>

                <button type="submit" id="submit-button" class="btn btn-dark px-5 fw-bold shadow-sm">
                    <i class="uil" th:classappend="${esEdicion ? 'uil-save' : 'uil-plus-circle'}"></i>
                    <span th:text="${esEdicion ? 'Guardar Cambios' : 'Crear Colección'}">Acción</span>
                </button>
            </div>

        </form>
    </div>

</div>

<th:block th:fragment="js-extra">
    <script>
        /*<![CDATA[*/
        const FUENTE_ESTATICA_URL = /*[[${fuenteEstaticaUrl}]]*/ 'http://localhost:4080';
        const FUENTE_DINAMICA_URL = /*[[${fuenteDinamicaUrl}]]*/ 'http://localhost:4040';
        const FUENTE_PROXY_API_URL = /*[[${fuenteProxiAPIUrl}]]*/ 'http://localhost:7080/api';

        function agregarCriterio() {
            const select = document.getElementById('tipoCriterioSelect');
            const tipo = select.value;
            if (!tipo) return;

            const container = document.getElementById('criterios-container');
            const index = container.querySelectorAll('.criterio-item').length;

            const div = document.createElement('div');
            div.className = 'criterio-item card border-0 shadow-sm mb-2 fade-in-up';

            let inputHtml = '';

            if (tipo.includes('FUENTE')) {
                inputHtml = `
                <select class="form-select form-select-sm" name="criterios[${index}].tipoFuente">
                    <option value="ESTATICA">Estática (CSV)</option>
                    <option value="DINAMICA">Dinámica (Interna)</option>
                    <option value="PROXY_API">Proxy API Cátedra</option>
                    <option value="PROXY_METAMAPA">Proxy Otra Instancia MetaMapa</option>
                </select>`;
            } else if (tipo.includes('FECHA')) {
                inputHtml = `
                <div class="input-group input-group-sm">
                    <span class="input-group-text">Desde</span>
                    <input type="date" class="form-control" name="criterios[${index}].fechaInicio">
                    <span class="input-group-text">Hasta</span>
                    <input type="date" class="form-control" name="criterios[${index}].fechaFin">
                </div>`;
            } else {
                let listAttr = "";
                let placeholder = "Valor...";

                if (tipo === 'FILTRO_PROVINCIA') {
                    listAttr = 'list="list-provincias"';
                    placeholder = "Seleccione Provincia...";
                } else if (tipo === 'FILTRO_MUNICIPIO') {
                    listAttr = 'list="list-municipios"';
                    placeholder = "Seleccione Municipio...";
                } else if (tipo === 'FILTRO_DEPARTAMENTO') {
                    listAttr = 'list="list-departamentos"';
                    placeholder = "Seleccione Departamento...";
                }

                inputHtml = `<input type="text" class="form-control form-control-sm" name="criterios[${index}].valor" placeholder="${placeholder}" ${listAttr}>`;
            }

            div.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between mb-2">
                    <strong class="text-primary small text-uppercase">${tipo.replace('FILTRO_', '')}</strong>
                    <button type="button" class="btn btn-link text-danger p-0 btn-sm" onclick="eliminarItem(this, '.criterio-item')">
                        <i class="uil uil-times"></i>
                    </button>
                </div>
                <input type="hidden" name="criterios[${index}].tipoFiltro" value="${tipo}">
                ${inputHtml}
            </div>
        `;

            container.appendChild(div);
            select.value = "";
        }

        function cambiarInputFuente(select) {
            const container = select.closest('.card-body').querySelector('.input-container');
            const tipo = select.value;
            const match = select.name.match(/\[(\d+)\]/);
            const index = match ? match[1] : 0;

            let htmlInput = '';

            switch (tipo) {
                case "ESTATICA":
                    htmlInput = `
                        <div class="input-group input-group-sm">
                            <input type="file" class="form-control fuente-input" 
                                   name="fuentes[${index}].url" accept=".csv" required>
                        </div>
                        <div class="form-text small text-muted">Sube un archivo .csv. Se procesará en segundo plano.</div>
                        `;
                    break;
                case "DINAMICA":
                    htmlInput = `
                        <input type="hidden" class="fuente-input" name="fuentes[${index}].url" value="${FUENTE_DINAMICA_URL}">
                        <div class="alert alert-info py-1 px-2 mb-0 small">
                            <i class="uil uil-info-circle"></i> Se usará la fuente dinámica interna.
                        </div>
                        `;
                    break;
                case "PROXY_API":
                    htmlInput = `
                        <input type="hidden" class="fuente-input" name="fuentes[${index}].url" value="${FUENTE_PROXY_API_URL}">
                        <div class="alert alert-warning py-1 px-2 mb-0 small text-dark border-warning border-opacity-25 bg-warning bg-opacity-10">
                            <i class="uil uil-server-network"></i> Conectando a API Cátedra
                        </div>
                        `;
                    break;
                case "PROXY_METAMAPA":
                    htmlInput = `
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="uil uil-link"></i></span>
                            <input type="url" class="form-control fuente-input" 
                                   placeholder="http://otra-instancia" 
                                   name="fuentes[${index}].url" required>
                        </div>
                        <div class="form-text small text-muted">Ingresa la URL base del Agregador externo.</div>
                        `;
                    break;
                default:
                    htmlInput = `<input type="text" class="form-control form-control-sm" disabled placeholder="Seleccione tipo...">`;
                    break;
            }

            container.innerHTML = htmlInput;
        }

        function agregarFuente() {
            const container = document.getElementById('fuentes-container');
            const emptyState = document.getElementById('empty-state-fuentes');
            if (emptyState) emptyState.style.display = 'none';

            const index = container.querySelectorAll('.fuente-item').length;

            const div = document.createElement('div');
            div.className = 'fuente-item card border-0 shadow-sm fade-in-up mb-3';

            // Actualizamos las opciones del SELECT
            div.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-secondary rounded-pill count-badge">Nueva</span>
                    <button type="button" class="btn btn-link text-danger p-0 btn-sm" onclick="eliminarItem(this, '.fuente-item')">
                        <i class="uil uil-trash-alt"></i>
                    </button>
                </div>
                <div class="row g-2">
                    <div class="col-12">
                        <select class="form-select form-select-sm mb-2" 
                                name="fuentes[${index}].tipoFuente" 
                                onchange="cambiarInputFuente(this)">
                            <option value="" selected disabled>Seleccionar tipo de fuente...</option>
                            <option value="ESTATICA">Fuente Estática (CSV)</option>
                            <option value="DINAMICA">Fuente Dinámica (Interna)</option>
                            <option value="PROXY_API">Proxy API Cátedra</option>
                            <option value="PROXY_METAMAPA">Proxy Otra Instancia MetaMapa</option>
                        </select>
                    </div>
                    <div class="col-12 input-container">
                        <input type="text" class="form-control form-control-sm" disabled placeholder="Seleccione tipo primero">
                    </div>
                </div>
            </div>
            `;
            container.appendChild(div);
        }

        function eliminarItem(btn, itemClass) {
            const item = btn.closest(itemClass);
            item.remove();
            reindexar(itemClass);
        }

        function reindexar(itemClass) {
            const items = document.querySelectorAll(itemClass);
            const emptyState = document.getElementById('empty-state-fuentes');

            if (itemClass === '.fuente-item' && items.length === 0 && emptyState) {
                emptyState.style.display = 'block';
            }

            items.forEach((item, i) => {
                if (itemClass === '.fuente-item') {
                    const badge = item.querySelector('.count-badge');
                    if (badge) badge.innerText = `Fuente #${i + 1}`;
                }

                item.querySelectorAll('input, select, textarea').forEach(el => {
                    if (el.name) {
                        el.name = el.name.replace(/\[\d+\]/, `[${i}]`);
                    }
                });
            });
        }

        document.getElementById('formColeccion').addEventListener('submit', async function (e) {
            const fileInputs = document.querySelectorAll('input[type="file"]');
            let hasFiles = false;

            fileInputs.forEach(i => {
                if (i.files.length > 0) hasFiles = true;
            });

            if (hasFiles) {
                e.preventDefault();

                const btn = document.getElementById('submit-button');
                const originalText = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Iniciando carga...';

                try {
                    for (const input of fileInputs) {
                        if (input.files.length > 0) {
                            const formData = new FormData();
                            formData.append("file", input.files[0]);
                            const resp = await fetch(FUENTE_ESTATICA_URL + "/api/fuentes", {
                                method: "POST",
                                body: formData
                            });

                            if (!resp.ok) {
                                const errorText = await resp.text();
                                throw new Error("Fallo al subir archivo a la fuente: " + errorText);
                            }
                            const data = await resp.json();
                            console.log("Fuente creada ID:", data.id);
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.name = input.name;
                            hiddenInput.value = FUENTE_ESTATICA_URL + "/api/fuentes/" + data.id;

                            input.parentNode.replaceChild(hiddenInput, input);
                        }
                    }

                    this.submit();

                } catch (error) {
                    console.error(error);
                    alert("Error durante la carga: " + error.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        });
        /*]]>*/
    </script>

    <style>
        .fade-in-up {
            animation: fadeInUp 0.3s ease-in-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</th:block>

</html>